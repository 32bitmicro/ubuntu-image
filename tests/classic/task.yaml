summary: Run ubuntu-image classic command tests
execute: |
    IMG_DEF_PATH=/home/ubuntu-image/ubuntu-images/ubuntu-server-pc-amd64.yaml

    ubuntu-image classic --debug --workdir /tmp/workdir $IMG_DEF_PATH

    IMG_NAME=$(cat $IMG_DEF_PATH | yq '.artifacts.img.[0].name')
    mkdir /tmp/loopback
    losetup --find --show --partscan /tmp/workdir/$IMG_NAME
    losetup -a |grep $IMG_NAME|cut -f1 -d: >> loop.txt
    LOOP="$(cat loop.txt)"

    for l in `ls -d "$LOOP"p*`
    do 
        p=${l#"$LOOP"}
        mkdir /tmp/$p
        mount $l /tmp/$p || true
    done

    ls /tmp/p3/


restore: |
    if [ -f loop.txt ]; then
        LOOP="$(cat loop.txt)"

        for l in `ls -d "$LOOP"p*`
        do 
            p=${l#"$LOOP"}
            mount --make-rprivate $l || true
            umount --recursive $l || true
        done

        losetup -d "$LOOP"
        sync
        losetup -l | NOMATCH "$LOOP"
        rm loop.txt
    fi

    rm -rf /tmp/workdir /tmp/loopback

